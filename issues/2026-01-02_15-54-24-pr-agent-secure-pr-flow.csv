id,priority,phase,area,title,description,acceptance_criteria,test_mcp,review_initial_requirements,review_regression_requirements,dev_state,review_initial_state,review_regression_state,git_state,owner,refs,notes
PRSAFE-010,P0,1,both,定义 PR 操作范围与验收口径,沉淀 PR 操作矩阵（允许/禁止）与验收标准，明确最小闭环与失败拦截点，作为后续策略与实现的边界合同。,新增/更新一份规范文档，包含允许/禁止动作清单、最小闭环步骤、失败拦截提示语与审计字段清单；Review 通过后合入主干。,AUTOSERVER,边界必须可枚举（动作/分支/仓库）；明确默认禁止合并/强推/向受保护分支写入；验收字段要可映射到审计日志 schema。,回归检查文档与实现是否一致（动作矩阵无漂移）；抽查至少 3 个失败场景的提示语与审计字段齐全。,已完成,已完成,已完成,已提交,,plan/2026-01-02_15-14-04-pr-agent-secure-pr-flow.md:20;docs/zh/guides/developer/pr-operator-security.md:1,picked_reason:P0 边界合同先行 | done_at:2026-01-02_17-06-18 | evidence:doc_added;backend_pytest:passed
PRSAFE-020,P0,2,both,建立威胁模型与安全基线,输出 PR 智能体的威胁模型与安全基线（最小权限、越权防护、注入防护、脱敏与审计），并明确必须由平台侧强制的约束点。,形成威胁模型清单（含缓解措施与残余风险）与安全基线条款；明确 token 权限策略与 repo allowlist/branch protection 对齐要求；结论被后续策略实现逐条引用。,AUTOSERVER,必须覆盖 token 泄漏、越权 repo/分支、提示词注入导致任意命令、受保护分支写入；所有结论可落到具体的校验点/配置项。,回归核对：策略引擎/网关/Executor 限制是否逐条满足基线；审计与脱敏措施是否闭环（日志/输出/异常栈）。,已完成,已完成,已完成,已提交,,plan/2026-01-02_15-14-04-pr-agent-secure-pr-flow.md:24;shared/utils/sensitive_data_masker.py:1;docs/zh/guides/developer/pr-operator-security.md:1,picked_reason:P0 安全基线先行 | done_at:2026-01-02_17-08-19 | evidence:threat_model+baseline_doc;backend_pytest:test_security_passed
PRSAFE-030,P1,3,backend,新增 PR 智能体 Ghost/Bot/Team 模板与契约字段,提供 pr-operator 的 CRD 资源模板，并将输入/输出 schema 契约化（结构化字段）以支持策略校验与审计。,新增/更新默认资源 YAML（包含 Ghost/Bot/Team）；systemPrompt 明确“仅在策略通过时写入”；输出契约字段列表在文档/Schema 中可追踪；启动加载或相关单测通过。,AUTOSERVER,提示词不得作为唯一安全控制；必须明确结构化输出字段与禁止动作；敏感信息不得写入示例。,回归验证默认资源可被系统加载；结构化字段被策略/网关消费（至少 1 条链路贯通）。,未开始,未开始,未开始,未提交,,plan/2026-01-02_15-14-04-pr-agent-secure-pr-flow.md:28;backend/init_data/01-default-resources.yaml:1;docs/zh/reference/yaml-specification.md:1,
PRSAFE-040,P1,4,both,确定 PR 操作工具链与最小能力面（MCP 优先）,优先通过 MCP 执行 PR API 操作并收敛 toolset 白名单；若需 gh/glab，则限定 Shell 能力与认证注入路径，支持只读降级。,明确并落地一种默认方案（MCP 或受限 CLI）；存在只读模式开关且默认生效；验证 token 不出日志/输出；工具能力清单可审计（配置可枚举）。,AUTOSERVER,工具能力必须可白名单化；禁止任意 shell 拼接；认证与 token 注入必须在受控模块完成并可脱敏。,回归验证：只读模式下无法创建/更新 PR；写入开启时仅允许 allowlist repo/base 分支；错误提示与审计记录完整。,未开始,未开始,未开始,未提交,,plan/2026-01-02_15-14-04-pr-agent-secure-pr-flow.md:32;docs/zh/guides/developer/config-web-search-and-mcp.md:1;executor/agents/claude_code/claude_code_agent.py:204,
PRSAFE-050,P0,5,backend,实现 PR Action Gateway（鉴权/策略/审计/幂等）,在后端提供统一 PR 动作入口，所有写操作必须经 RBAC + policy gate，支持幂等与可追溯审计。,新增 PR 动作 API（至少 create PR / update PR / request review 之一）并具备：权限校验、策略拒绝理由、幂等键去重、审计落库；后端单测覆盖允许/拒绝与幂等重试。,AUTOSERVER,所有外部请求必须有超时/重试边界；错误码与拒绝理由稳定可解析；日志/审计不得包含 token。,跑 `cd backend && uv run pytest`；回归验证重复提交不会生成重复 PR；跨 repo/跨用户越权请求必须被拒绝并可审计。,已完成,已完成,已完成,已提交,,plan/2026-01-02_15-14-04-pr-agent-secure-pr-flow.md:36;shared/utils/sensitive_data_masker.py:1;backend/app/api/endpoints/pr_actions.py:17;backend/app/services/pr_action_gateway.py:93;backend/app/services/pr_policy.py:24;backend/app/models/pr_action_audit.py:15;backend/alembic/versions/p6q7r8s9t0u1_add_pr_action_audits_table.py:1;docs/zh/guides/developer/pr-operator-security.md:65,"picked_reason:P0 且是所有写操作的统一安全入口;done_at:2026-01-02_17-49-20;evidence:api=/api/pr/actions/create-pr;audit=pr_action_audits;idempotency=uq(user_id,idempotency_key);backend_pytest:passed"
PRSAFE-060,P0,6,backend,实现可配置策略引擎（repo/base/路径/阈值/检查项）,实现 Policy 评估：repo allowlist、base 分支限制、分支命名、diff 阈值、禁止路径、必须通过检查项；输出机器可读拒绝原因。,策略引擎具备可配置规则与默认策略；对至少 6 类规则有单测（允许/拒绝）；拒绝结果包含稳定 code 与 human-readable message；可被 Gateway 调用。,AUTOSERVER,规则必须可枚举且可组合；拒绝原因不可泄漏敏感信息；性能边界明确（避免每次评估拉全量外部数据）。,跑 `cd backend && uv run pytest`；回归验证策略覆盖负向用例（受保护分支/越权 repo/禁止路径/超阈值 diff）。,已完成,已完成,已完成,已提交,,plan/2026-01-02_15-14-04-pr-agent-secure-pr-flow.md:40;backend/app/services/pr_policy.py:24;backend/app/services/pr_action_gateway.py:146;backend/app/services/pr_policy.py:68;backend/app/core/config.py:85;backend/tests/services/test_pr_policy.py:19;docs/zh/guides/developer/pr-operator-security.md:108,picked_reason:P0 且直接决定写操作是否安全可控（Gateway 依赖）;done_at:2026-01-02_17-55-06;evidence:policy_rules=repo_allowlist+base_allowlist+branch_regex+diff_threshold+forbidden_paths+required_checks;gateway_call=enabled;backend_pytest:passed
PRSAFE-070,P0,7,both,Executor/Shell 隔离与最小化执行面（git 与 PR API 分离）,将代码生成+git 写入放入隔离环境执行，限制命令与文件/网络范围；将 git 操作与 PR API 操作拆成受控步骤，降低注入风险。,Executor 对 PR 相关任务具备受限命令白名单或等价隔离；认证注入路径可审计且脱敏；至少 1 个集成测试覆盖“尝试执行非白名单命令被拒绝”。,AUTOSERVER,不得将用户输入直接拼接为 shell；token 不得出现在 debug 日志；容器/工作目录生命周期明确（任务结束清理）。,跑 `cd executor && uv run pytest`（如涉及 manager 则也跑对应 pytest）；回归验证 GitHub CLI 登录失败不会泄漏 token 且行为可降级。,未开始,未开始,未开始,未提交,,plan/2026-01-02_15-14-04-pr-agent-secure-pr-flow.md:44;executor/agents/claude_code/claude_code_agent.py:150,
PRSAFE-080,P0,8,both,补齐测试矩阵（单测/集成/端到端 + 负向用例）,为策略、脱敏、幂等、网关与执行链路补齐自动化测试，并在 sandbox 仓库跑端到端验证。,单测覆盖策略允许/拒绝、脱敏、幂等；集成测试覆盖 create/update PR；端到端验证通过“创建分支→提交→推送→创建 PR→审计记录”，并包含至少 2 个负向用例（向 main 推送、访问非 allowlist repo）。,AUTOE2E,测试必须可重复、无外部依赖漂移（必要时 mock）；负向用例必须验证拒绝理由与审计记录。,全量跑 `cd backend && uv run pytest`、`cd executor && uv run pytest`、`cd executor_manager && uv run pytest`、`cd shared && uv run pytest`；端到端回归跑对应 E2E 命令（若有）。,未开始,未开始,未开始,未提交,,plan/2026-01-02_15-14-04-pr-agent-secure-pr-flow.md:48,
PRSAFE-090,P1,9,both,上线开关与降级回滚（只读默认、逐步放量）,通过 feature flag 分阶段开放能力（只读→写），并提供一键降级到只读/禁用高危 toolset/关闭写路由的回滚方案。,存在可配置开关且默认只读；写入开启需显式配置；降级开关切换后写操作立即不可用且审计/告警仍可用；提供操作手册/Runbook。,AUTOE2E,降级路径必须独立于业务逻辑且可快速生效；开关命名与默认值清晰；避免多处重复开关导致配置漂移。,回归验证开关组合：只读/写入/降级三态行为一致；端到端验证降级后写请求被拒绝且理由稳定。,未开始,未开始,未开始,未提交,,plan/2026-01-02_15-14-04-pr-agent-secure-pr-flow.md:53,
