"id","priority","phase","area","title","description","acceptance_criteria","test_mcp","review_initial_requirements","review_regression_requirements","dev_state","review_initial_state","review_regression_state","git_state","owner","refs","notes"
"CSR-000","P0","1","both","固化 Code Shell Resume 契约与命名","统一对外字段与 UI 文案命名，明确“Resume=续聊/恢复上下文”与“chat:resume=断线续流”的区别。","在代码与 i18n 中落盘统一命名：Codex 使用 resume_session_id、ClaudeCode 使用 session_id、重试选择使用 retry_mode(resume/new_session)；前端具备 Resume Badge 与两类重试按钮的 i18n key；对外不使用 chat:resume 命名。","AUTOSERVER","命名需可枚举且一致；避免与 chat:resume 语义混淆；字段仅用于控制流/状态，不进入 prompt 文本。","旧客户端/旧事件不因新增字段报错；非 Code Shell 消息的重试/错误展示不受影响。","已完成","已完成","已完成","已提交","","plan/2026-01-06_16-11-39-code-shell-resume-mode.md:56;backend/app/api/ws/events.py:154;docs/guides/developer/i18n-rules.md:1","picked_reason:P0 但多处已实现，补齐类型/文案/契约说明后闭环; done_at:2026-01-08; evidence:frontend lint; jest (12 suites passed)"
"CSR-010","P0","2","backend","后端下发会话状态并透传 retry_mode","让 Codex/ClaudeCode 子任务拿到“当前会话信息”，并在 chat:retry 中支持用户选择 resume 或 new_session。","ChatRetryPayload 支持 retry_mode(resume/new_session) 且 on_chat_retry 可持久化到将重跑的 assistant subtask；dispatch 到 executor 时携带 Codex 的 resume_session_id 或 ClaudeCode 的 session_id；retry reset 逻辑：resume 保留会话字段、new_session( Codex 清空 resume_session_id / ClaudeCode 生成并持久化新 session_id )；聚合 prompt 仅取 result.value 不注入内部字段；新增/更新单测并通过 `cd backend && uv run pytest`。","AUTOSERVER","保持 Subtask.result 内部字段与 prompt 内容隔离；retry_mode 默认值/兼容性清晰；会话字段持久化位置与并发重试一致性。","覆盖边界：缺失会话字段、重复 retry、任务失败后两种 retry 都可触发；验证 chat:resume(断线续流) 逻辑不受影响。","已完成","已完成","已完成","已提交","","plan/2026-01-06_16-11-39-code-shell-resume-mode.md:64;backend/app/services/adapters/executor_kinds.py:840;backend/app/api/ws/events.py:154;backend/app/api/ws/chat_namespace.py:960;backend/app/services/chat/operations/retry.py:119","picked_reason:P0 且解阻塞（后端先打通 retry_mode/会话状态下发链路）; done_at:2026-01-08; evidence:backend pytest (417 passed)"
"CSR-020","P0","3","executor","CodexAgent 默认续聊：优先 codex exec resume","同一 Task 内只要已有 resume_session_id，则默认走 `codex exec resume`；用户选择 new_session 时强制新会话。","存在 resume_session_id 且 retry_mode!=new_session 时使用 `codex exec --json resume <id> -`；否则使用 `codex exec --json -` 并在首次运行解析 thread.started.thread_id 写入 result.resume_session_id 回传；new_session 重试忽略旧 resume_session_id 并生成新 id；失败时写入 result.error(可选 error_code) 便于前端展示；新增/更新单测并通过 `cd executor && uv run pytest`。","AUTOSERVER","命令选择逻辑需可测试；解析事件仅依赖 thread.started.thread_id；错误包含可定位细节；避免将 session_id 注入 prompt。","同一 Task 多轮对话链路：首次创建→后续 resume→失败后 new_session→后续继续沿用新会话；确保 Codex HOME/会话存储一致性假设在文档/日志中可排查。","已完成","已完成","已完成","已提交","","plan/2026-01-06_16-11-39-code-shell-resume-mode.md:75;executor/agents/codex/codex_agent.py:248","picked_reason:P0 且紧接后端完成，尽快打通 Codex 续聊链路; done_at:2026-01-08; evidence:executor pytest (90 passed)"
"CSR-030","P0","4","executor","ClaudeCode 支持同一 Task 的新会话切换","保持默认续聊，但在 retry_mode=new_session 时切到后端下发的新 session_id，并用其作为 client cache key。","ClaudeCodeAgent 读取 payload.session_id(缺省回退 task_id) 并用作 Claude SDK session_id；client cache key 从 task_id 平滑迁移到 session_id；retry_mode=new_session 时使用新 session_id 执行并回传 result.session_id，后端可据此持久化替换该 Task 的当前会话；新增/更新单测并通过 `cd executor && uv run pytest`。","AUTOSERVER","cache key 迁移需兼容存量任务；new_session 只影响当前 Task 会话状态不改 Bot 配置；失败时错误信息可定位。","验证：默认续聊不回归；new_session 后后续消息默认沿用新 session；并发/快速重试下不会复用旧 cache。","已完成","已完成","已完成","已提交","","plan/2026-01-06_16-11-39-code-shell-resume-mode.md:85;executor/agents/claude_code/claude_code_agent.py:110","picked_reason:P0 且与 Codex 对齐，尽快支持 ClaudeCode 同 Task 新会话切换; done_at:2026-01-08; evidence:executor pytest (92 passed)"
"CSR-040","P0","5","frontend","前端展示 Resume Badge 与二选一重试","在 Code Shell 消息气泡头部展示 Resume Badge；失败时提供“Resume 重试/新会话重试”两个按钮并透传 retry_mode。","MessageBubble 在 Codex/ClaudeCode 消息头部(Bot 名称旁)展示 Resume Badge；当 Code Shell AI 消息失败时将单一重试入口替换为两个按钮：resume 与 new_session；点击后通过 WS 发送 chat:retry 并携带 retry_mode；若缺少 resume_session_id 且选择 resume，UI 明确提示并引导使用新会话重试；`cd frontend && npm run lint` 与 `npm test` 通过。","AUTOFRONTEND","复用现有错误展示块并支持可展开原始错误；按钮与文案走 i18n；非 Code Shell 消息保持现有 retry 行为。","验证 Codex/ClaudeCode 两种 shell 的失败重试交互一致；新会话重试后 Resume Badge 仍正确；排序/消息状态(completed/error) 不回归。","已完成","已完成","已完成","已提交","","plan/2026-01-06_16-11-39-code-shell-resume-mode.md:91;frontend/src/features/tasks/components/message/MessageBubble.tsx:1249;frontend/src/features/tasks/contexts/chatStreamContext.tsx:739","picked_reason:P0 且后端/执行器已就绪，前端补齐可见性与双重试入口; done_at:2026-01-08; evidence:frontend lint; jest (12 suites passed)"
"CSR-050","P0","6","both","补齐单测与回归（E2E 优先）","为会话续聊/双重试链路补齐可自动化验证，优先 Playwright；若无法稳定自动化则做交互式回归并留证据。","后端/Executor/前端测试均新增覆盖并通过：`cd backend && uv run pytest`、`cd executor && uv run pytest`、`cd frontend && npm run lint`、`cd frontend && npm test`；至少覆盖 1 条端到端验证：同一 Task 多轮续聊 + 失败后双按钮重试 + new_session 后继续续聊（Playwright 用例优称）；若不做 E2E，则在 PR/issue 中附截图、控制台日志与关键网络请求作为回归证据。","AUTOE2E","测试用例避免依赖不稳定时序；关键断言围绕 retry_mode 与会话 id 的持久化/下发/回传；错误信息断言包含可定位字段。","回归覆盖：resume 不可用时的错误展示；new_session 替换后后续默认续聊；非 Code Shell 对话与 chat:resume(断线续流) 不回归。","已完成","已完成","已完成","已提交","","plan/2026-01-06_16-11-39-code-shell-resume-mode.md:104;docs/guides/developer/testing.md:1;frontend/src/features/tasks/components/message/MessageBubble.tsx:1;frontend/src/__tests__/features/tasks/message-bubble.code-shell-retry.test.tsx:1;frontend/e2e/tests/tasks/code-shell-retry-mode.spec.ts:1","picked_reason:P0 收口回归与证据，避免功能漂移; done_at:2026-01-08; evidence:backend pytest (417 passed); executor pytest (92 passed); frontend lint (exit 0); frontend jest (70 tests passed); playwright e2e/tests/tasks/code-shell-retry-mode.spec.ts (3 passed)"
"CSR-060","P1","7","both","文档更新与默认续聊回滚开关","补充开发文档，并提供 feature flag 以关闭默认续聊与双按钮重试入口，便于灰度/回滚。","更新 `docs/guides/developer/codex-shell-parity.md`，记录 Codex 使用 `codex exec resume <SESSION_ID>` 与字段来源；提供可配置的 feature flag：关闭后强制 Code Shell 走新会话(不使用 resume_session_id)且前端隐藏/禁用“Resume 重试/新会话重试”两个按钮（避免用户误解）；具备最小验证路径（单测或手动步骤）并记录到文档/PR。","AUTOE2E","feature flag 作用域清晰(仅 Code Shell)；默认值与发布策略明确；关闭后不影响现有 chat:resume 与普通 Chat。","验证 flag 开/关两套路径均可工作；关闭时 UI 不再出现 Resume 语义；开启时恢复默认续聊与双按钮重试。","已完成","已完成","已完成","已提交","","plan/2026-01-06_16-11-39-code-shell-resume-mode.md:110;docs/guides/developer/codex-shell-parity.md:1;docs/guides/developer/codex-shell-parity.md:45;backend/app/core/config.py:75;backend/app/services/adapters/executor_kinds.py:1151;backend/app/services/chat/operations/retry.py:152;frontend/src/app/runtime-config/route.ts:52;frontend/src/lib/runtime-config.ts:153;frontend/src/features/tasks/components/message/MessageBubble.tsx:1299;.env.defaults:21;backend/tests/services/test_executor_kinds_code_shell_resume_flag.py:1;frontend/src/__tests__/features/tasks/message-bubble.code-shell-retry.test.tsx:1","picked_reason:P1 补齐文档与回滚开关，便于灰度/快速回退; done_at:2026-01-08; evidence:backend pytest (targeted: 20 passed); frontend lint (exit 0); frontend jest (71 tests passed)"
