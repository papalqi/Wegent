---
mode: plan
cwd: /root/project/Wegent
task: 对话界面显示细粒度执行状态与进度（docker启动中/执行中等）
complexity: medium
planning_method: builtin
created_at: 2026-01-02T14:34:19+08:00
---

# Plan: 对话界面状态提示与进度优化（docker 启动中 / 任务执行中）

🎯 任务概述
在聊天/任务对话界面增加更细粒度的状态反馈（如“Docker 启动中”“正在执行任务”）并提供进度感知（百分比/步骤进度），让用户在 Bot 执行阶段有明确等待提示，而不是只有“执行中”。

📋 执行计划
1. 明确状态枚举与触发点：梳理执行链路（启动容器、拉取镜像、加载技能、执行步骤、结束），定义前端需要展示的状态文案及对应后端事件/字段。
2. 后端事件/状态输出检查：查 Task/Bot 执行的 WebSocket 事件和 REST 轮询数据，确认是否已有细粒度信号；若缺失，设计补充字段（如 status_detail 或 phase）并在任务流中填充。
3. WebSocket/轮询协议调整：为细粒度状态与进度定义稳定字段（如 `status_phase`、`progress`/`progress_text`），向后兼容（旧客户端忽略新增字段）。
4. 进度计算策略：若后端可提供真实进度（步骤数/百分比），直接透出；若暂缺，用阶段占比的“伪进度”方案（如 0–20% 启动、20–40% 拉镜像、40–90% 执行、90–100% 收尾）并在完成/失败时收敛。
5. 前端状态模型更新：在 `useUnifiedMessages` 或任务状态 store 中接入新增字段，建立“阶段/进度 → 文案/图标/颜色/进度条”映射，覆盖 chat header / message list 的加载提示区。
6. UI/文案设计与实现：新增状态提示组件（顶部 banner 或 card 内 badge + 线性进度条），示例文案：“Docker 启动中…”，“拉取镜像…”，“执行中…”，“收尾/同步中…”，进度条与文案同步。
7. 回退/异常处理：未知阶段降级为“执行中”；progress 缺失时仅显示状态文案；错误状态提供重试/查看日志入口。
8. 测试与验证：补充前端单测/Story（状态/进度映射、降级逻辑），如后端事件调整则加单元/集成测试；必要时添加 E2E（模拟阶段和进度）。
9. 文档与变更说明：在 `docs/zh/guides/developer/chat-message-flow.md` 和/或 UX 文档记录新增状态/进度字段与文案策略。

⚠️ 风险与注意事项
- 事件兼容性：新增字段不能破坏现有客户端；需保持旧字段含义不变。
- 状态来源可信度：如果执行链路无法准确发出阶段事件，文案会误导用户；需验证关键阶段能可靠触发。
- UI 侵入度：避免在消息流中刷屏，可采用顶部/卡片内的轻量提示。

📎 参考
- 前端消息单一数据源：`useUnifiedMessages`（参见 docs/zh/guides/developer/chat-message-flow.md）
- 设计基调：Calm UI（低饱和/留白）
